angular.module("JSFight",["ui.router","btford.socket-io"]).constant("API",{url:"http://localhost:3000/api/"}).run(["$rootScope","$state","$stateParams","$location",function(a,b,c){a.$state=b,a.$stateParams=c,a.$on("$stateChangeStart",function(b,c,d,e,f){a.user=JSON.parse(localStorage.getItem("user"))})}]),angular.module("JSFight").directive("keypressEvents",["$document","$rootScope",function(a,b){return{restrict:"A",link:function(){console.log("linked"),a.bind("keypress",function(a){b.$broadcast("keypress",a,String.fromCharCode(a.which))})}}}]),angular.module("JSFight").value("Formatter",function(a,b){return a+" - "+b+"\n"}),angular.module("JSFight").controller("AuthCtrl",["$scope","$state","$rootScope","Auth",function(a,b,c,d){a.login=function(){d.login(a.form.username,a.form.password).success(function(a){localStorage.setItem("user",JSON.stringify(a)),c.$broadcast("login",a),b.transitionTo("home")})},a.signup=function(){d.signup(a.form.username,a.form.password).success(function(a){localStorage.set("user",JSON.stringify(a)),c.$broadcast("login",a),b.transitionTo("home")})}}]),angular.module("JSFight").controller("ChatCtrl",["$scope","$http","$log","Chat","API","Formatter",function(a,b,c,d,e,f){a.user=JSON.parse(localStorage.getItem("user")),a.user&&(a.user=a.user.user),a.messageLog="",a.load=function(){b.get(e.url+"/messages").success(function(b){b.forEach(function(b){a.messageLog=f(b.sender,b.content)+a.messageLog})})},a.sendMessage=function(){d.emit("message",a.user.local.username,a.message),a.message=""},a.$on("socket:broadcast",function(b,c){a.$apply(function(){a.messageLog=f(c.sender,c.content)+a.messageLog})}),a.load()}]),angular.module("JSFight").controller("HomeCtrl",["$scope","$state","$rootScope","Auth",function(a,b,c,d){a.user=JSON.parse(localStorage.getItem("user")),a.user&&(a.user=a.user.user),c.$on("login",function(b){a.user=b}),c.$on("logout",function(){a.user=null}),a.logout=function(){d.logout().success(function(a){localStorage.removeItem("user"),c.$broadcast("logout"),b.transitionTo("home")})}}]),angular.module("JSFight").controller("LetsFight",["$scope",function(a){var b=new SVGLib(document.getElementById("wannaFight"));a.player="player1",a.opponent="player2",a.message="Let's Fight !",a.player1=new Player(b,"default",200,200,a),a.player2=new Player(b,"default",700,200,a),a[a.player].movingLeft=!1,a[a.player].movingRight=!1,a[a.player].movingTop=!1,a[a.player].movingBot=!1,a[a.player].crouched=!1,a[a.player].attacking=!1,a[a.player].direciton=-1,a[a.player].jumping=0,a[a.opponent].attacking=!0,document.addEventListener("keydown",function(b){37==b.keyCode&&(a[a.player].movingLeft=!0),65==b.keyCode&&(a[a.player].attacking||a[a.player].blocking||(a[a.player].attacking=!0,a[a.player].punch(20,a,a[a.player].direction,a.opponent))),90==b.keyCode&&(a[a.player].attacking||a[a.player].blocking||(a[a.player].attacking=!0,a[a.player].punch(50,a,a[a.player].direction,a.opponent))),69==b.keyCode&&(a[a.player].attacking||a[a.player].blocking||(a[a.player].attacking=!0,a[a.player].punch(100,a,a[a.player].direction,a.opponent))),39==b.keyCode&&(a[a.player].movingRight=!0),32!=b.keyCode||a[a.player].crouched||(1===a[a.player].jumping?a[a.player].jump(60,a,a[a.player].stopJump()):0===a[a.player].jumping&&a[a.player].jump(60,a,a[a.player].getY())),40==b.keyCode&&(a[a.player].crouched||a[a.player].jumping||a[a.player].crouch(30,a)),81==b.keyCode&&(a[a.player].attacking||a[a.player].blocking||(a[a.player].attacking=!0,a[a.player].kick(20,a,a[a.player].direction,a.opponent))),83==b.keyCode&&(a[a.player].attacking||a[a.player].blocking||(a[a.player].attacking=!0,a[a.player].kick(50,a,a[a.player].direction,a.opponent))),68==b.keyCode&&(a[a.player].attacking||a[a.player].blocking||(a[a.player].attacking=!0,a[a.player].kick(100,a,a[a.player].direction,a.opponent)))}),setInterval(function(){a[a.player].movingLeft&&(a[a.player].direction>0&&a[a.opponent].attacking&&!a[a.player].jumping?a[a.player].blockUp(10,a,a[a.player].direction):(a[a.player].blocking&&a[a.player].unblock(a),a[a.player].attacking||a[a.player].moveLeft())),a[a.player].movingRight&&(a[a.player].direction<0&&a[a.opponent].attacking&&!a[a.player].jumping?a[a.player].blockUp(10,a,a[a.player].direction):(a[a.player].blocking&&a[a.player].unblock(a),a[a.player].attacking||a[a.player].moveRight())),a[a.player].x-a[a.opponent].x>0?(a[a.player].direction=-1,a[a.opponent].direction=1):(a[a.player].direction=1,a[a.opponent].direction=-1),a[a.player].buildStickmanJSON(),a[a.opponent].buildStickmanJSON(),a[a.player].health<=0?a.message="you loose !":a[a.opponent].health<=0&&(a.message="you win !"),a.$apply()},10),setInterval(function(){a[a.opponent].attacking=!0,a[a.opponent].kick(100,a,a[a.opponent].direction,a.player)},2e3),document.addEventListener("keyup",function(b){37==b.keyCode&&(a[a.player].movingLeft=!1,a[a.player].blocking=!1),39==b.keyCode&&(a[a.player].movingRight=!1,a[a.player].blocking=!1),38==b.keyCode&&(a[a.player].movingTop=!1),40==b.keyCode&&a[a.player].up(30,a)})}]).directive("playground",function(){return{templateNamespace:"svg",templateUrl:"/templates/svg.html",replace:!0}});var Player=function(a,b,c,d,e,f){var g=this;g.SVG=null,g.init=function(a,b,c,d,e,f){g.health=100,g.SVG=a,g.x=c,g.id=f,g.y=d,g.height=100,g.buildStickmanJSON(),g.armx=g.x,g.legx=g.x,g.blockx=g.x,g.blocky=g.y+g.height,g.bodyy2=g.y+g.height},g.drawStickman=function(){console.log(e),g.SVG.drawLine("body",e.body,g.id,e)},g.jump=function(a,b,c){g.initialHeight=g.y;var d=!1,e=!0;g.jumping++,g.jumpInterval=setInterval(function(){g.initialHeight-a<g.y&&!d&&e?(g.y--,g.y--):d||(e=!1,g.y++,g.y++,g.y==c&&(d=!0)),g.buildStickmanJSON(),b.$apply(),d&&(g.jumping=0,clearInterval(g.jumpInterval))},1)},g.stopJump=function(){return clearInterval(g.jumpInterval),g.initialHeight},g.getY=function(){return g.y},g.getX=function(){return g.x},g.moveLeft=function(){return g.crouched?0:(g.x--,g.x--,g.x--,g.punching&&(g.armx-=3),void(g.kicking&&(g.legx-=3)))},g.moveRight=function(){return g.crouched?0:(g.x++,g.x++,g.x++,g.punching&&(g.armx+=3),void(g.kicking&&(g.legx+=3)))},g.crouch=function(a,b){g.crouched=!0,g.bodyy1+=a,g.buildStickmanJSON(),b.$apply()},g.up=function(a,b){g.crouched=!1,g.bodyy1-=a,g.buildStickmanJSON(),b.$apply()},g.blockUp=function(a,b,c){g.blocking=!0,g.blockx=g.x+a*c,g.blocky=g.y+g.height,g.buildStickmanJSON(),b.$apply()},g.unblock=function(a){g.blocking=!1,g.blockx=g.x,g.blocky=g.y,g.buildStickmanJSON(),a.$apply()},g.punch=function(a,b,c,d){var e=!0,f=!1;g.punching=!0,console.log(c),g.punchInterval=setInterval(function(){g.armx!=g.x+a*c&&!f&&e?(g.armx+=c,g.armx+=c):f||(e=!1,g.armx-=c,g.armx-=c,g.x==g.armx&&(f=!0)),e&&(b[d].x<g.armx&&c>0&&b[d].x>g.x||b[d].x>g.armx&&0>c&&b[d].x<g.x)&&!b[d].blocking&&(b[d].health-=a/5,console.log(b[d].health),e=!1),g.buildStickmanJSON(),b.$apply(),f&&(g.attacking=!1,g.punching=!1,clearInterval(g.punchInterval))},1)},g.kick=function(a,b,c,d){var e=!0,f=!1;g.kicking=!0,g.kickInterval=setInterval(function(){g.legx!=g.x+a*c&&!f&&e?g.legx+=c:f||(e=!1,g.legx-=c,g.x==g.legx&&(f=!0)),e&&(b[d].x<g.legx&&c>0&&b[d].x>g.x||b[d].x>g.legx&&0>c&&b[d].x<g.x)&&!b[d].blocking&&(b[d].health-=a/5,console.log(b[d].health),e=!1),g.buildStickmanJSON(),b.$apply(),f&&(g.attacking=!1,g.kicking=!1,clearInterval(g.kickInterval))},1)},g.buildStickmanJSON=function(){g.punching||(g.armx=g.x),g.kicking||(g.legx=g.x),g.crouched||(g.bodyy1=g.y),g.blocking||(g.blocky=g.y,g.blockx=g.x),g.health>75?g.healthColor="green":g.health>50?g.healthColor="yellow":g.health>25?g.healthColor="orange":g.healthColor="red",g.health<0&&(g.health=0),g.body={x1:g.x,y1:g.bodyy1,x2:g.x,y2:g.y+g.height,stroke:"black",strokeWidth:7},g.head={cx:g.x,cy:g.bodyy1,r:10,stroke:"black",strokeWidth:7,fill:"black"},g.arm={x1:g.x,y1:g.bodyy1+20,x2:g.armx,y2:g.bodyy1+20,stroke:"black",strokeWidth:7},g.leg={x1:g.x,y1:g.bodyy1+60,x2:g.legx,y2:g.y+g.height,stroke:"black",strokeWidth:7},g.block={x1:g.blockx,y1:g.blocky,x2:g.blockx,y2:g.y,stroke:"blue",strokeWidth:4},g.lifeBar={x1:g.x-g.health/2,y1:g.bodyy1-50,x2:g.x+g.health/2,y2:g.bodyy1-50,stroke:g.healthColor,strokeWidth:6}},g.init(a,b,c,d,e,f)},SVGLib=function(){var a=this;a.createWorkspace=function(){a.workspace=document.createElementNS("http://www.w3.org/2000/svg","svg")},a.addSVG=function(a){console.log(a)},a.testJSON=function(a){try{JSON.parse(a)}catch(b){return console.log(b),!1}return!0},a.draw=function(b){a.addSVG(b)},a.init=function(b){for(var c=0;c<b.length;c++)b[c]&&1===b[c].nodeType&&(a.targetDiv=b[c]);return a.targetDiv?void a.createWorkspace():(console.log("Error, enter a valid div"),1)},a.createTag=function(a){return document.createElement(a)},a.drawCircle=function(b,c){var d=a.createTag("circle");d.setAttribute("id",b);for(var e in c)d.setAttribute(e,c[e]);a.draw(d)},a.drawLine=function(b,c,d){var e=a.createTag("line");e.setAttribute("id",b+d),e.setAttribute("stroke-linecap","round");for(var f in c)if("number"==typeof c[f]||"string"==typeof c[f])e.setAttribute(f,"{{player"+d+"."+b+"."+f+"}}");else if("object"==typeof c[f]){var g="";for(var h in c[f])g+=h+"("+c[f][h]+") ";e.setAttribute(f,g)}a.draw(e)},a.getPlayerJSON=function(a,b){var c=new XMLHttpRequest;c.open("GET","ressources/"+a+".json",!0),c.onreadystatechange=function(){return 4==c.readyState&&200==c.status?(b.desc={json:c.responseText},b.buildData(),0):void 0},c.send()},a.init(arguments)};angular.module("JSFight").config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"../views/home.html",controller:"HomeCtrl"}).state("login",{url:"/login",templateUrl:"../views/auth/login.html",controller:"AuthCtrl"}).state("signup",{url:"/signup",templateUrl:"../views/auth/signup.html",controller:"AuthCtrl"}).state("game",{url:"/game",templateUrl:"../views/core_game/core_game_client.html",controller:"fighterCtrl"})}]),angular.module("JSFight").factory("Auth",["$http","API",function(a,b){return{signup:function(c,d){return a.post(b.url+"signup",{username:c,password:d})},login:function(c,d){return a.post(b.url+"login",{username:c,password:d})},logout:function(){return a.get(b.url+"logout")}}}]),angular.module("JSFight").factory("Chat",["socketFactory",function(a){var b=a();return b.forward("broadcast"),b}]),angular.module("JSFight").factory("Fight",["$http","API",function(a,b){return{}}]);